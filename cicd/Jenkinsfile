pipeline {
    agent any
    stages {
        stage('Services') {
            parallel {
                stage('Server') {
										when { expression { load("cicd/hasChanges.groovy").checkChanges('services/server') } }
                    stages {
                        stage('Pre Build') { steps { sh 'services/server/scripts/pre-build.sh' } }
												stage('Build') { steps { sh 'services/server/scripts/build.sh' } }
												stage('Deploy') { steps { sh 'services/server/scripts/deploy-test-env.sh' } }
												stage('E2E Tests') { steps { sh 'services/server/scripts/e2e.sh' } }
                    }
                }
                stage('Client') {
										when { expression { load("cicd/hasChanges.groovy").checkChanges('services/client') } }
                    stages {
                        stage('Pre Build') { steps { sh 'services/client/scripts/pre-build.sh' } }
												stage('Build') { steps { sh 'services/client/scripts/build.sh' } }
												stage('Deploy') { steps { sh 'services/client/scripts/deploy-test-env.sh' } }
												stage('E2E Tests') { steps { sh 'services/client/scripts/e2e.sh' } }
                    }
                }
								stage('Hasura') {
										when { expression { load("cicd/hasChanges.groovy").checkChanges('services/hasura') } }
                    stages {
                        stage('Pre Build') { steps { sh 'services/hasura/scripts/pre-build.sh' } }
												stage('Build') { steps { sh 'services/hasura/scripts/build.sh' } }
												stage('Deploy') { steps { sh 'services/hasura/scripts/deploy-test-env.sh' } }
												stage('E2E Tests') { steps { sh 'services/hasura/scripts/e2e.sh' } }
                    }
                }
								stage('DB') {
										when { expression { load("cicd/hasChanges.groovy").checkChanges('services/db') } }
                    stages {
                        stage('Pre Build') { steps { sh 'services/db/scripts/pre-build.sh' } }
												stage('Build') { steps { sh 'services/db/scripts/build.sh' } }
												stage('Deploy') { steps { sh 'services/db/scripts/deploy-test-env.sh' } }
												stage('E2E Tests') { steps { sh 'services/db/scripts/e2e.sh' } }
                    }
                }
            }
        }
				stage('Post Pipleline') {
					steps {
						echo 'Post Pipeline...'
					}
				}
    }
}
