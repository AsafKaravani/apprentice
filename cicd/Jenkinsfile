pipeline {
    agent any
    stages {
				stage('Install Yarn') {
            steps {
                script {
                    // Check if Yarn is installed and install it if not
                    sh 'which yarn || curl -o- -L https://yarnpkg.com/install.sh | sh'
                    // Optionally, add Yarn to PATH if not already configured globally
                    sh 'export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"'
                }
            }
        }

				stage('Install Packages') {
						steps {
								script {
										// Install dependencies
										sh 'yarn install'
								}
						}
				}
				
        stage('Services') {
            parallel {
                stage('Server') {
                    stages {
                        stage('Pre Build') { steps { sh 'bash services/server/scripts/pre-build.sh' } }
												stage('Build') { steps { sh 'bash services/server/scripts/build.sh' } }
                    }
                }
                stage('Client') {
                    stages {
                        stage('Pre Build') { steps { sh 'bash services/client/scripts/pre-build.sh' } }
												stage('Build') { steps { sh 'bash services/client/scripts/build.sh' } }
                    }
                }
								stage('Hasura') {
                    stages {
                        stage('Pre Build') { steps { sh 'bash services/hasura/scripts/pre-build.sh' } }
												stage('Build') { steps { sh 'bash services/hasura/scripts/build.sh' } }
                    }
                }
								stage('DB') {
                    stages {
                        stage('Pre Build') { steps { sh 'bash services/db/scripts/pre-build.sh' } }
												stage('Build') { steps { sh 'bash services/db/scripts/build.sh' } }
                    }
                }
            }
        }
				stage('Deploy Environment') {
					parallel { 
						stage('Changed Services') {
								steps {
										script {
												def dirsList = load("cicd/functions.groovy").getChangedDirs()
												for (dir in dirsList) {
														echo "Changed directory: ${dir}"
												}
										}
								}
						}
						stage('Not Changed Services') {
								steps {
										script {
												def dirsList = load("cicd/functions.groovy").getNonChangedDirs()
												for (dir in dirsList) {
														echo "Changed directory: ${dir}"
												}
										}
								}
						}

					}
				}
				stage('E2E Tests') {
					steps {
						echo 'Running e2e tests...'
					}
				}
    }
}
